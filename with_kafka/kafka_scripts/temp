from kafka import KafkaConsumer
import json
from datetime import date
today = date.today()

def kafka_consumer():
    kafka_broker = 'localhost:9092'
    kafka_topic = 'monthly_visitor_data'

    consumer = KafkaConsumer(kafka_topic, bootstrap_servers=kafka_broker, value_deserializer=lambda x: json.loads(x.decode('utf-8')))

    for message in consumer:
        data = message.value
        if data == b'END_OF_STREAM':  # Check for the end of stream message
            print("End of stream message received. Exiting the consumer.")
            break
        data = message.value.decode('utf-8')
        print("Received data from Kafka topic:")
        # Save the JSON data to a file
        data = data.replace("\'", "\"")
        with open(f'../data/monthly_data/{today.strftime("%Y-%m-%d")}_monthly_visitor_data.json', 'w') as json_file:
                json_file.write(json.dumps(json.loads(data), indent=4))
        print(f"Data saved as JSON: monthly_visitor_data_{message.timestamp}.json")


if __name__ == '__main__':
    kafka_consumer()